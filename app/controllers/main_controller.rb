class MainController < ApplicationController
  def index; end

  def create
    base_prompt = params[:base_prompt]

    if base_prompt.blank?
      @input_error = "å…¥åŠ›ã—ã¦ã‹ã‚‰ã€Œå¤‰æ›ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„"
      @output = nil
      render :index

    else
      style = params[:style]
      tone = params[:tone]
      emoji = params[:emoji]
      radio_emoji = params[:radio_emoji]
      strength = params[:strength]

      Rails.logger.debug "é¸æŠã•ã‚ŒãŸemojiã‚¿ã‚¤ãƒ—: #{emoji}"

      case radio_emoji
      when "no_kaomoji"
        emoji_rule ="é¡”ç³»çµµæ–‡å­—ï¼ˆğŸ˜ŠğŸ˜‚ğŸ˜¢ãªã©ï¼‰ã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã§ãã ã•ã„"
      when "no_icon"
        emoji_rule = "ã‚¢ã‚¤ã‚³ãƒ³ç³»çµµæ–‡å­—(â¤ï¸ ğŸ’” â­ ğŸ”¥ğŸ ğŸš—ğŸ“±ãªã©ï¼‰ã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã§ãã ã•ã„ã€ãŸã ã—æ‰‹ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ï¼ˆğŸ‘Œ ğŸ‘ ğŸ™Œ ğŸ™ãªã©ï¼‰ã¯ä½¿ã£ã¦ã‚ˆã„"
      when "nothing"
        emoji_rule = "çµµæ–‡å­—ã¯ä½•ã§ã‚‚ä½¿ã£ã¦ãã ã•ã„"
      else
        emoji_rule = ""
      end

      case tone
      when "formal"
        tone_rule = "ä¸å¯§ã§ã‹ã—ã“ã¾ã£ãŸè¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚æ´¾æ‰‹ãªçµµæ–‡å­—ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚é–¢è¥¿å¼ã®å ´åˆã¯ã€ã€œã—ã¦ã¯ã‚Šã¾ã™ã‹ã€ã€ã€œã•ã‚Œã¯ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ãªã©ã€å®Ÿéš›ã«ä½¿ã‚ã‚Œã‚‹ä¸å¯§ãªé–¢è¥¿å¼ã«ã—ã¦ãã ã•ã„ã€‚ä¸è‡ªç„¶ãªè¨€ã„å›ã—ã¯é¿ã‘ã¦ãã ã•ã„ã€‚"
      when "casual"
        tone_rule = "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„è¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚çµµæ–‡å­—ã¯æ¥½ã—ããƒãƒ©ãƒ³ã‚¹ã‚ˆãä½¿ã£ã¦ãã ã•ã„ã€‚é–¢è¥¿å¼ã®å ´åˆã¯ã€ã€œã—ã¦ã‚‹ã‚“ï¼Ÿã€ã€ã€œã‚„ã­ã‚“ã€ãªã©ã€æ—¥å¸¸ä¼šè©±ã§ã‚ˆãä½¿ã†è‡ªç„¶ãªè¨€ã„æ–¹ã«ã—ã¦ãã ã•ã„ã€‚"
      when "frank"
        tone_rule = "ç •ã‘ãŸç‡ç›´ãªè¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚çµµæ–‡å­—ã¯è‡ªç”±ã«ãŸãã•ã‚“ä½¿ã£ã¦æ§‹ã„ã¾ã›ã‚“ãŒstrengthã«åˆã‚ã›ã¦ã„ã„å¡©æ¢…ã«ã—ã¦ãã ã•ã„ã€‚é–¢è¥¿å¼ã®å ´åˆã¯ã€ã€œã‚„ã‚ã€ã€ã€œã¡ã‚ƒã†ï¼Ÿã€ãªã©è‡ªç„¶ãªé›‘è«‡é¢¨ã«ã—ã¦ãã ã•ã„ã€‚å®Ÿéš›ã«æ—¥å¸¸ä¼šè©±ã§ä½¿ã‚ãªã„ä¸è‡ªç„¶ãªè¡¨ç¾ï¼ˆä¾‹:ã€ã‚ã‚ŠãŒã¨ã•ã‚“ãªã€ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚"
      else
        tone_rule = ""
      end

      case strength
      when "weak"
        strength_rule = <<~RULE
        çµµæ–‡å­—ã¯1æ–‡ã«1ã¤ç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚
        é–¢è¥¿å¼ã®å ´åˆã¯æŸ”ã‚‰ã‹ã„è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚ä¸è‡ªç„¶ãªé–¢è¥¿å¼ï¼ˆä¾‹:ã€ã‚ã‚ŠãŒã¨ã•ã‚“ãªã€ã€ã‚ã‚ŠãŒã¨ã‚„ã§ã€ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
        ä¾‹:
        - ã€Œçªãå½“ãŸã‚Šã€ã¯ã€Œã©ã‚“ã¤ãã€ã€ç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ãƒã‚«â†’ã‚¢ãƒ›ã€è¡Œãé€”ä¸­â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—
        - åŒã˜â†’ãŠã‚“ãªã—ãƒ»ãŠãªã—ã€å‹•ãâ†’ã„ã”ãã€ç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„ã€æ¨ã¦ã‚‹â†’ã»ã‹ã™ã€é•ã†â†’ã¡ã‚ƒã†ã€è¾›ã„ã€ãˆã‚‰ã„
        - ã—ãªã„â†’ã›ã‡ã¸ã‚“ãƒ»ã—ãƒã²ã‚“ã€ã„ãªã„â†’ãŠã‚‰ã‚“
        - ã¾ãã¾ããƒ»ãã‚ãã‚â†’ã¼ã¡ã¼ã¡ã€ã˜ã‚ƒã‚ã­â†’ã»ãªã­ã€ã¾ãŸã­â†’ã»ãªã¾ãŸ

      RULE
      when "medium"
        strength_rule = <<~RULE
        çµµæ–‡å­—ã¯1æ–‡ã«2ã¤ç¨‹åº¦, ã‚‚ã—ãã¯ã²ã¨å˜èªã«ï¼‘ã¤ã«ã—ã¦ãã ã•ã„ã€‚
        é–¢è¥¿å¼ã®å ´åˆã¯è‡ªç„¶ã§æ—¥å¸¸çš„ãªè¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚
        ä¾‹:
        - ã€Œçªãå½“ãŸã‚Šã€ã¯ã€Œã©ã‚“ã¤ãã€ã€ç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ãƒã‚«â†’ã‚¢ãƒ›ã€è¡Œãé€”ä¸­â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—
        - åŒã˜â†’ãŠã‚“ãªã—ãƒ»ãŠãªã—ã€å‹•ãâ†’ã„ã”ãã€ç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„ã€æ¨ã¦ã‚‹â†’ã»ã‹ã™ã€é•ã†â†’ã¡ã‚ƒã†ã€è¾›ã„ã€ãˆã‚‰ã„
        - ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€Œã‚ã‚ŠãŒã¨ã†ãªã€ã€ŒåŠ©ã‹ã‚‹ã‚ã€ã¨è¨€ã„æ›ãˆã‚‹
        - ã—ãªã„â†’ã›ã‡ã¸ã‚“ãƒ»ã—ãƒã²ã‚“ã€ã„ãªã„â†’ãŠã‚‰ã‚“
        - ã¾ãã¾ãâ†’ã¼ã¡ã¼ã¡ã€ã˜ã‚ƒã‚ã­â†’ã»ãªã­ã€ã¾ãŸã­â†’ã»ãªã¾ãŸ
        - ä¸è‡ªç„¶ãªå¤ã„è¨€è‘‰ã‚„ä½¿ã‚ã‚Œãªã„è¡¨ç¾ã¯ä½¿ã‚ãªã„
      RULE
      when "strong"
        strength_rule = <<~RULE
        çµµæ–‡å­—ã¯1æ–‡ã«3ã¤ä»¥ä¸Šã€ã¾ãŸã¯å˜èªã”ã¨ã«è¤‡æ•°å…¥ã‚Œã¦ãã ã•ã„ã€‚
        é–¢è¥¿å¼ã®å ´åˆã¯ã‚³ãƒ†ã‚³ãƒ†ã§ç‰¹å¾´çš„ãªè¡¨ç¾ã«ã—ã¦ãã ã•ã„ã€‚
        ä¾‹:
        - ã€Œçªãå½“ãŸã‚Šã€ã¯ã€Œã©ã‚“ã¤ãã€ã€ç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ãƒã‚«â†’ã‚¢ãƒ›ã€è¡Œãé€”ä¸­â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—
        - åŒã˜â†’ãŠã‚“ãªã—ãƒ»ãŠãªã—ã€å‹•ãâ†’ã„ã”ãã€ç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„,æ¨ã¦ã‚‹â†’ã»ã‹ã™ã€é•ã†â†’ã¡ã‚ƒã†ã€è¾›ã„ã€ãˆã‚‰ã„
        - ãªã„â†’ã‚ã‚‰ã¸ã‚“ã€æ€’ã‚‹â†’ã„ã‚‰ã†ãƒ»ã‹ãªã‚“ã€ã§ããªã„â†’ã§ã‘ã¸ã‚“
        - ã¾ãã¾ãâ†’ã¼ã¡ã¼ã¡ã€ã˜ã‚ƒã‚ã­â†’ã»ãªã­ã€ã¾ãŸã­â†’ã»ãªã¾ãŸ
        - å‰æœ¬æ–°å–œåŠ‡ãªã©ã§ã¤ã‹ã‚ã‚Œã‚‹ã‚ˆã†ãªè¡¨ç¾ã‚’ä½¿ã†
        - ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ŒãŠãŠãã«ãªã€ã€ãŠé¡˜ã„â†’é ¼ã‚€ã‚
      RULE
      else
        strength_rule = ""
      end

      case emoji
      when "add"
        prompt = <<~PROMPT
          æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµµæ–‡å­—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
          ã€Œ#{base_prompt}ã€

          æ¡ä»¶:
          - çµµæ–‡å­—ã¯æ–‡è„ˆã«åˆã£ãŸã‚‚ã®ã ã‘ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚æ—¥å¸¸ä¼šè©±ã«é–¢ä¿‚ãªã„ã‚‚ã®ï¼ˆğŸ“¦ã‚„ğŸš€ãªã©çªæ‹å­ã‚‚ãªã„ã‚‚ã®ï¼‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
          - äººã‚„æ„Ÿæƒ…ãƒ»å‹•ä½œã«é–¢é€£ã™ã‚‹çµµæ–‡å­—ï¼ˆğŸ˜ŠğŸ˜‚ğŸ˜¢ğŸ‘ğŸ™ğŸ™Œãªã©ï¼‰ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
          - æ–‡ç« ã®å†…å®¹ã¯å¤‰æ›´ã—ãªã„
          - çµµæ–‡å­—ã®é¸ã³æ–¹ã«ãƒˆãƒ¼ãƒ³ã€Œ#{tone_rule}ã€ã‚’åæ˜ ã™ã‚‹
          - ç¿»è¨³ã¯ã—ãªã„ã§ãã ã•ã„ã€‚å…¥åŠ›æ–‡ã‚’ãã®ã¾ã¾ä½¿ã„ã€çµµæ–‡å­—ã ã‘ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
          - æ—¥æœ¬èªã®è¡¨ç¾ï¼ˆè¨€è‘‰é£ã„ï¼‰ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„ã€‚
          - #{emoji_rule}
          - #{strength_rule}
        PROMPT
      when "kansai"
        prompt = <<~PROMPT
          æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é–¢è¥¿å¼ã«ç¿»è¨³ã—ã¦ãã ã•ã„ï¼ˆç¿»è¨³ã®ã¿ã€èª¬æ˜ãªã—ï¼‰ï¼š
          ã€Œ#{base_prompt}ã€

          æ¡ä»¶:
          - ç¿»è¨³çµæœã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„
          - å…¥åŠ›åˆ†ä»¥å¤–ã®æ–‡ç« ã‚„èª¬æ˜ã¯çµ¶å¯¾ã«è¿½åŠ ã—ãªã„ã§ãã ã•ã„

          - ãƒˆãƒ¼ãƒ³: #{tone_rule}
          - çµµæ–‡å­—ã¯ä½¿ã‚ãªã„
          - #{strength_rule}
        PROMPT
      when "emoji_kansai"
        prompt = <<~PROMPT
        ã‚ãªãŸã¯ç¿»è¨³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
        ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œé–¢è¥¿å¼ï¼‹çµµæ–‡å­—ä»˜ãã€ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚
        å‡ºåŠ›ã¯ç¿»è¨³çµæœã®ã¿ã§ã€èª¬æ˜ã‚„æ¡ä»¶æ–‡ã¯çµ¶å¯¾ã«å‡ºã•ãªã„ã“ã¨ã€‚

        å…¥åŠ›: ã€Œ#{base_prompt}ã€

        å‡ºåŠ›æ¡ä»¶:
        - å…¥åŠ›æ–‡ã‚’å¿…ãšç¿»è¨³ã™ã‚‹ï¼ˆçŸ­æ–‡ã‚„å˜èªã ã‘ã§ã‚‚ç¿»è¨³ã™ã‚‹ï¼‰
        - å…¥åŠ›æ–‡ä»¥å¤–ã®æ–‡ç« ã¯è¿½åŠ ã—ãªã„
        - ç¿»è¨³çµæœã ã‘ã‚’è¿”ã™
        - ãƒˆãƒ¼ãƒ³: #{tone_rule}ï¼ˆé–¢è¥¿å¼ã¨çµµæ–‡å­—ã§è¡¨ç¾ï¼‰
        - #{emoji_rule}
        - #{strength_rule}

        å‡ºåŠ›:
      PROMPT
      else
        @output_error = "å¤‰æ›ã‚¿ã‚¤ãƒ—ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"
        render :index and return
      end

      begin
        result = OpenaiService.generate_text(prompt)
        # æ–‡é ­ã¨æ–‡æœ«ã«ã‚ã‚‹ã€Œã€ã‚’å‰Šé™¤
        # æ–‡é ­ãƒ»æ–‡æœ«ã«ã‚ã‚‹ã€Œã‚„ã€ãªã©ã®ä½™è¨ˆãªæ‹¬å¼§ã‚’å‰Šé™¤
        result = result.gsub(/\A[ã€Œ]+|[ã€]+$/, "")
        result = result.gsub(/[ã€Œã€]/, "")
        @input_text = base_prompt
        @output = result
      rescue Timeout::Error
        @api_error = "OpenAIã®å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        @output = nil
      rescue StandardError => e
        case e.message
        when /401/
          @api_error = "APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚ ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚"
        when /429/
          @global_error = "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
        else
          @global_error = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚#{e.message}"
        end
        @output = nil
      end
      render :index
    end
  end
end
