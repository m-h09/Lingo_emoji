class EmojiConverterService
  FACE_EMOJIS = ["ğŸ˜¥","ğŸ˜Š","ğŸ˜‚","ğŸ¤£"].freeze
  ICON_EMOJIS = ["ğŸ“š","ğŸ‰","ğŸš—","ğŸ£"].freeze

  def initialize(base_prompt:, style:, tone:, emoji:, radio_emoji:, strength:)
    @base_prompt = base_prompt
    @style = style
    @tone = tone
    @emoji = emoji
    @radio_emoji = radio_emoji
    @strength = strength
  end

  def call
    prompt = build_prompt
    result = OpenaiService.generate_text(prompt)
    clean_text(result)
  end

  private

  # ---------------------------
  # å„é¸æŠã—ã”ã¨ã®ãƒ«ãƒ¼ãƒ«
  # ---------------------------
  # å£èª¿Ã—çµµæ–‡å­—ã®ã‚¬ã‚¤ãƒ‰ã ã‘
  def tone_emoji_rule
    case @tone
    when "formal"
      "çµµæ–‡å­—ã¯åŸºæœ¬ä½¿ã‚ãªã„ã€‚ä½¿ã†å ´åˆã‚‚æœ€å°é™ã«ã™ã‚‹ã€‚"
    when "casual"
      "çµµæ–‡å­—ã¯æ¥½ã—ãã€ãƒãƒ©ãƒ³ã‚¹ã‚ˆãä½¿ã†ã€‚"
    when "frank"
      "çµµæ–‡å­—ã¯è‡ªç”±ã«å¤šã‚ã§ã‚‚ã‚ˆã„ã€‚"
    else
      ""
    end
  end

  # å£èª¿Ã—é–¢è¥¿å¼ã®ã‚¬ã‚¤ãƒ‰ã ã‘
  def tone_kansai_rule
    case @tone
    when "formal"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - ä¸å¯§ãªé–¢è¥¿å¼ï¼ˆã€Œã€œã—ã¦ã¯ã‚Šã¾ã™ã‹ã€ã€Œã€œã•ã‚Œã¯ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€ãªã©ï¼‰ã‚’ä½¿ã†ã€‚
        - ä¸è‡ªç„¶ãªè¨€ã„å›ã—ã¯é¿ã‘ã‚‹ã€‚
      RULE
    when "casual"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - è‡ªç„¶ã§æ—¥å¸¸çš„ãªé–¢è¥¿å¼ï¼ˆã€Œã€œã—ã¦ã‚‹ã‚“ï¼Ÿã€ã€Œã€œã‚„ã­ã‚“ã€ãªã©ï¼‰ã«ã™ã‚‹ã€‚
      RULE
    when "frank"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - ç •ã‘ãŸé›‘è«‡èª¿ï¼ˆã€Œã€œã‚„ã‚ã€ã€Œã€œã¡ã‚ƒã†ï¼Ÿã€ãªã©ï¼‰ã«ã™ã‚‹ã€‚
        - ä¸è‡ªç„¶ãªè¡¨ç¾ï¼ˆä¾‹:ã€Œã‚ã‚ŠãŒã¨ã•ã‚“ãªã€ç­‰ï¼‰ã¯ä½¿ã‚ãªã„ã€‚
      RULE
    else
      ""
    end
  end

    # çµµæ–‡å­—ã ã‘
  def strength_emoji_rule
    case @strength
    when "weak"
      <<~RULE
        ã€çµµæ–‡å­—ã®ä½¿ã„æ–¹ã€‘
        - çµµæ–‡å­—ã¯1æ–‡ã«1ã¤ç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚
      RULE
    when "medium"
      <<~RULE
        ã€çµµæ–‡å­—ã®ä½¿ã„æ–¹ã€‘
        - çµµæ–‡å­—ã¯1æ–‡ã«2ã¤ç¨‹åº¦ã€ã‚‚ã—ãã¯å˜èªã”ã¨ã«1ã¤å…¥ã‚Œã¦ãã ã•ã„ã€‚
      RULE
    when "strong"
      <<~RULE
        ã€çµµæ–‡å­—ã®ä½¿ã„æ–¹ã€‘
        - çµµæ–‡å­—ã¯1æ–‡ã«3ã¤ä»¥ä¸Šå…¥ã‚Œã¦ãã ã•ã„ã€‚å˜èªã”ã¨ã«è¤‡æ•°å…¥ã‚Œã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
      RULE
    else
      ""
    end
  end

  # é–¢è¥¿å¼ã ã‘
  def strength_kansai_rule
    case @strength
    when "weak"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - æŸ”ã‚‰ã‹ãè‡ªç„¶ãªé–¢è¥¿å¼ã«ã—ã¦ãã ã•ã„ã€‚
        - èªå°¾ã¯ã€Œã€œã‚„ã­ã‚“ã€ã€Œã€œã—ã¦ã‚‹ã‚“ï¼Ÿã€ãªã©æ—¥å¸¸çš„ãªè¡¨ç¾ã‚’ä½¿ã†ã€‚
        - ä¸è‡ªç„¶ãªè¡¨ç¾ï¼ˆä¾‹:ã€ã‚ã‚ŠãŒã¨ã•ã‚“ãªã€ã€ã‚ã‚ŠãŒã¨ã‚„ã§ã€ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã€‚
        - è¨€ã„æ›ãˆä¾‹: ã€Œçªãå½“ãŸã‚Šâ†’ã©ã‚“ã¤ãã€ã€Œç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ã€Œç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„ã€ã€Œè¡Œãé€”ä¸­ãƒ»è¡ŒããŒã‘â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€ã€Œå¸°ã‚ŠãŒã‘ãƒ»å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—ã€ã€ŒåŒã˜â†’ãŠã‚“ãªã—ã€ã€Œå‹•ãâ†’ã„ã”ãã€ã€Œé•ã†â†’ã¡ã‚ƒã†ã€ã€Œå¤§å¤‰â†’ãˆã‚‰ã„ã€
          ã€Œã—ãªã„â†’ã›ã‡ã¸ã‚“/ã—ãƒã²ã‚“ã€ã€Œã„ãªã„â†’ãŠã‚‰ã‚“ã€ã€Œãã‚ãã‚ãƒ»ã¾ãã¾ãâ†’ã¼ã¡ã¼ã¡ã€ã€Œã˜ã‚ƒã‚ã­ãƒ»ã¾ãŸã­â†’ã»ãªã­/ã»ãªã¾ãŸã€
      RULE
    when "medium"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - è‡ªç„¶ã§æ—¥å¸¸çš„ãªé–¢è¥¿å¼ã«ã—ã¦ãã ã•ã„ã€‚
        - èªå°¾ã¯ã€Œã€œã‚„ã‚ã€ã€Œã€œã¡ã‚ƒã†ï¼Ÿã€ãªã©ã€‚
        - ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€Œã‚ã‚ŠãŒã¨ã†ãªã€ã€ŒåŠ©ã‹ã‚‹ã‚ã€ã¸ã€‚
        - ä¸è‡ªç„¶ã§å¤ã„è¡¨ç¾ã¯é¿ã‘ã‚‹ã€‚
        - è¨€ã„æ›ãˆä¾‹: ã€Œçªãå½“ãŸã‚Šâ†’ã©ã‚“ã¤ãã€ã€Œç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ã€Œç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„ã€ã€Œè¡Œãé€”ä¸­ãƒ»è¡ŒããŒã‘â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€ã€Œå¸°ã‚ŠãŒã‘ãƒ»å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—ã€ã€ŒåŒã˜â†’ãŠã‚“ãªã—ã€ã€Œå‹•ãâ†’ã„ã”ãã€ã€Œé•ã†â†’ã¡ã‚ƒã†ã€ã€Œå¤§å¤‰â†’ãˆã‚‰ã„ã€
          ã€Œã—ãªã„â†’ã›ã‡ã¸ã‚“/ã—ãƒã²ã‚“ã€ã€Œã„ãªã„â†’ãŠã‚‰ã‚“ã€ã€Œãã‚ãã‚ãƒ»ã¾ãã¾ãâ†’ã¼ã¡ã¼ã¡ã€ã€Œã˜ã‚ƒã‚ã­ãƒ»ã¾ãŸã­â†’ã»ãªã­/ã»ãªã¾ãŸã€
      RULE
    when "strong"
      <<~RULE
        ã€é–¢è¥¿å¼å¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ã€‘
        - ã‚³ãƒ†ã‚³ãƒ†ã§æ¿ƒã„é–¢è¥¿å¼ã«ã—ã¦ãã ã•ã„ã€‚
        - å‰æœ¬æ–°å–œåŠ‡é¢¨ã®ãƒãƒªã‚‚å¯ã€‚
        - ã€Œãªã„ã€â†’ã€Œã‚ã‚‰ã¸ã‚“ã€ã€ã€Œæ€’ã‚‹ã€â†’ã€Œã„ã‚‰ã†ãƒ»ã‹ãªã‚“ã€ç­‰ã®å¼·ã„è¨€ã„æ›ãˆã€‚
        - ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ŒãŠãŠãã«ãªã€ã€ã€ŒãŠé¡˜ã„ã€ã¯ã€Œé ¼ã‚€ã‚ã€ã€‚
        - èªå°¾ã¯ã€Œã€œã‚„ã‚“ã‘ã€ã€Œã€œã‚„ãªã„ã‹ã€ãªã©ã‚‚å¯ã€‚
        - è¨€ã„æ›ãˆä¾‹: ã€Œçªãå½“ãŸã‚Šâ†’ã©ã‚“ã¤ãã€ã€Œç™½ã€…ã—ã„â†’ã—ã‚‰ã“ã„ã€ã€Œç–²ã‚ŒãŸâ†’ã—ã‚“ã©ã„ã€ã€Œè¡Œãé€”ä¸­ãƒ»è¡ŒããŒã‘â†’è¡Œãã—ãªãƒ»è¡Œãã—ã€ã€Œå¸°ã‚ŠãŒã‘ãƒ»å¸°ã‚‹é€”ä¸­â†’å¸°ã‚Šã—ãªãƒ»å¸°ã‚Šã—ã€ã€ŒåŒã˜â†’ãŠã‚“ãªã—ã€ã€Œå‹•ãâ†’ã„ã”ãã€ã€Œé•ã†â†’ã¡ã‚ƒã†ã€ã€Œå¤§å¤‰â†’ãˆã‚‰ã„ã€
          ã€Œã—ãªã„â†’ã›ã‡ã¸ã‚“/ã—ãƒã²ã‚“ã€ã€Œã„ãªã„â†’ãŠã‚‰ã‚“ã€ã€Œãã‚ãã‚ãƒ»ã¾ãã¾ãâ†’ã¼ã¡ã¼ã¡ã€ã€Œã˜ã‚ƒã‚ã­ãƒ»ã¾ãŸã­â†’ã»ãªã­/ã»ãªã¾ãŸã€
      RULE
    else
      ""
    end
  end

  def emoji_rule
    case @radio_emoji
    when "no_kaomoji"
      "é¡”ç³»çµµæ–‡å­—ï¼ˆğŸ˜ŠğŸ˜‚ğŸ˜¢ãªã©ï¼‰ã¯ä¸€åˆ‡ä½¿ã‚ãªã„ã§ãã ã•ã„"
    when "no_icon"
      "ã‚¢ã‚¤ã‚³ãƒ³ç³»çµµæ–‡å­—ï¼ˆğŸ“šğŸš—ãªã©ï¼‰ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„..."
    when "nothing"
      "çµµæ–‡å­—ã¯ä½•ã§ã‚‚ä½¿ã£ã¦ãã ã•ã„"
    else
      ""
    end
  end

  # ---------------------------
  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
  # ---------------------------
  def build_prompt
    case @emoji
    when "add"
      <<~PROMPT
        æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã«çµµæ–‡å­—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
        #{@base_prompt}

        æ¡ä»¶:
        - #{tone_emoji_rule}
        - #{strength_emoji_rule}
        - #{emoji_rule}
        - å…¥åŠ›æ–‡ã‚’ãã®ã¾ã¾å¤‰æ›ã—ã¦ãã ã•ã„ã€‚ä¸è¦ãªæ–‡ã‚’è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚
      PROMPT
    when "kansai"
      <<~PROMPT
        æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é–¢è¥¿å¼ã«ç¿»è¨³ã—ã¦ãã ã•ã„ï¼š
        #{@base_prompt}

        æ¡ä»¶:
        - #{tone_kansai_rule}
        - #{strength_kansai_rule}
        - çµµæ–‡å­—ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ï¼ˆçµµæ–‡å­—ã«é–¢ã™ã‚‹ä»–ã®æŒ‡ç¤ºãŒã‚ã£ã¦ã‚‚ç„¡è¦–ã™ã‚‹ï¼‰
        - å…¥åŠ›æ–‡ã‚’ãã®ã¾ã¾å¤‰æ›ã—ã€ä¸è¦ãªæ–‡ã¯è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚
      PROMPT
    when "emoji_kansai"
      <<~PROMPT
        ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é–¢è¥¿å¼ï¼‹çµµæ–‡å­—ä»˜ãã«ã—ã¦ãã ã•ã„ï¼š
        #{@base_prompt}

        æ¡ä»¶:
        - #{tone_kansai_rule}
        - #{strength_kansai_rule}   # é–¢è¥¿å¼ã®æ¿ƒã•
        - #{strength_emoji_rule}    # çµµæ–‡å­—ã®é‡
        - #{emoji_rule}
        - å…¥åŠ›æ–‡ã‚’ãã®ã¾ã¾å¤‰æ›ã—ã€ä¸è¦ãªæ–‡ã¯è¿½åŠ ã—ãªã„ã§ãã ã•ã„ã€‚
      PROMPT
    else
      ""
    end
  end

  # ---------------------------
  # å‡ºåŠ›å¾Œã®ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å†…å®¹ã«å¿œã˜ã¦çµµæ–‡å­—ã‚’å‰Šé™¤ï¼‰
  # ---------------------------
  def clean_text(text)
    case @radio_emoji
    when "no_kaomoji"
      remove_face_emojis(text)
    when "no_icon"
      remove_icon_emojis(text)
    when "nothing"
      remove_face_and_icon_emojis(text)
    else
      text
    end
  end

  def remove_face_emojis(text)
    text.gsub(Regexp.union(FACE_EMOJIS), "")
  end

  def remove_icon_emojis(text)
    text.gsub(Regexp.union(ICON_EMOJIS), "")
  end

  def remove_face_and_icon_emojis(text)
    remove_icon_emojis(remove_face_emojis(text))
  end
end
